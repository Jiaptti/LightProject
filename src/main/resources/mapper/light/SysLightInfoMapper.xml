<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.viroyal.light.module.light.dao.SysLightInfoMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.viroyal.light.module.light.entity.SysLightInfo">
        <id column="id" property="id"/>
        <result column="code" property="code"/>
        <result column="light_info" property="lightInfo"/>
        <result column="status" property="status"/>
        <result column="longitude" property="longitude"/>
        <result column="latitude" property="latitude"/>
        <result column="strategy_id" property="strategyId"/>
        <result column="user_id" property="userId"/>
        <result column="street_id" property="streetId"/>
        <result column="group_id" property="groupId"/>
        <result column="auto_report" property="autoReport"/>
        <result column="voltage_threshold" property="voltageThreshold"/>
        <result column="current_threshold" property="currentThreshold"/>
        <result column="temperature_threshold" property="temperatureThreshold"/>
        <result column="humidity_threshold" property="humidityThreshold"/>
        <result column="lightness_threshold" property="lightnessThreshold"/>
        <result column="voltage_overload" property="voltageOverload"/>
        <result column="current_overload" property="currentOverload"/>
        <result column="temperature_overload" property="temperatureOverload"/>
        <result column="humidity_overload" property="humidityOverload"/>
        <result column="lightness_overload" property="lightnessOverload"/>
        <result column="open_time" property="openTime"/>
        <result column="close_time" property="closeTime"/>
        <result column="exist" property="exist"/>
    </resultMap>

    <!-- 获得所有路灯 -->
    <select id="queryAll" resultMap="BaseResultMap">
		select distinct i.id, i.code, i.`status`, i.current_overload, i.humidity_overload,i.auto_report,
		i.street_id,i.user_id,i.group_id,
		i.current_threshold, i.light_info, i.latitude, i.lightness_overload, i.humidity_threshold,
		i.lightness_threshold, i.longitude, i.strategy_id, i.temperature_overload,
		i.temperature_threshold, i.voltage_overload, i.voltage_threshold,
		ls.open_time, ls.close_time
		from sys_light_info as i
		left join sys_light_strategy as ls on i.strategy_id = ls.id
		where i.exist = 1
	</select>

    <!-- 获得城市下的路灯 -->
    <select id="queryByCity" parameterType="Long" resultMap="BaseResultMap">
		select distinct i.id, i.code, i.`status`, i.current_overload, i.humidity_overload,i.auto_report,
		i.street_id,i.user_id,i.group_id,
		i.current_threshold, i.light_info, i.latitude, i.lightness_overload, i.humidity_threshold,
		i.lightness_threshold, i.longitude, i.strategy_id, i.temperature_overload,
		i.temperature_threshold, i.voltage_overload, i.voltage_threshold,
		ls.open_time, ls.close_time
		from sys_light_info as i
		left join sys_light_strategy as ls on i.strategy_id = ls.id
		left join sys_region as r on r.common_region_id = i.street_id
		where r.common_region_id like CONCAT(#{cityId}, '%')  and r.region_desc = '街道' and i.exist = 1 and r.exist = 1
	</select>

    <!-- 获得区下的路灯 -->
    <select id="queryByArea" parameterType="Long" resultMap="BaseResultMap">
		select i.id, i.code, i.`status`, i.current_overload, i.humidity_overload,i.auto_report,
		i.street_id,i.user_id,i.group_id,
		i.current_threshold, i.light_info, i.latitude, i.lightness_overload, i.humidity_threshold,
		i.lightness_threshold, i.longitude, i.strategy_id, i.temperature_overload,
		i.temperature_threshold, i.voltage_overload, i.voltage_threshold,
		ls.open_time, ls.close_time
		from sys_light_info as i
		left join sys_light_strategy as ls on i.strategy_id = ls.id
		left join sys_region as r on r.common_region_id = i.street_id
		where r.up_region_id = #{areaId} and i.exist = 1 and r.exist = 1
	</select>

    <!-- 获得街道下的路灯 -->
    <select id="queryByStreet" parameterType="Long" resultMap="BaseResultMap">
		select i.id, i.code, i.`status`, i.current_overload, i.humidity_overload,i.auto_report,
		i.street_id,i.user_id,i.group_id,
		i.current_threshold, i.light_info, i.latitude, i.lightness_overload, i.humidity_threshold,
		i.lightness_threshold, i.longitude, i.strategy_id, i.temperature_overload,
		i.temperature_threshold, i.voltage_overload, i.voltage_threshold,
		ls.open_time, ls.close_time
		from sys_light_info as i
		left join sys_light_strategy as ls on i.strategy_id = ls.id
		where i.street_id = #{streetId} and i.exist = 1
	</select>

    <!-- 获得组下的路灯 -->
    <select id="queryByGroup" parameterType="Long" resultMap="BaseResultMap">
        select i.id, i.code, i.`status`, i.current_overload, i.humidity_overload,i.auto_report,
        i.street_id,i.user_id,i.group_id,
		i.current_threshold, i.light_info, i.latitude, i.lightness_overload, i.humidity_threshold,
		i.lightness_threshold, i.longitude, i.strategy_id, i.temperature_overload,
		i.temperature_threshold, i.voltage_overload, i.voltage_threshold,
		ls.open_time, ls.close_time
		from sys_light_info as i
		left join sys_light_strategy as ls on i.strategy_id = ls.id
		where i.group_id = #{groupId} and i.exist = 1
	</select>

    <!-- 获得维修员的路灯 -->
    <select id="queryByUser" parameterType="Long" resultMap="BaseResultMap">
		select i.id, i.code, i.`status`, i.current_overload, i.humidity_overload,i.auto_report,
		i.street_id,i.user_id,i.group_id,
		i.current_threshold, i.light_info, i.latitude, i.lightness_overload, i.humidity_threshold,
		i.lightness_threshold, i.longitude, i.strategy_id, i.temperature_overload,
		i.temperature_threshold, i.voltage_overload, i.voltage_threshold,
		ls.open_time, ls.close_time
		from sys_light_info as i
		left join sys_light_strategy as ls on i.strategy_id = ls.id
		where i.user_id = #{userId} and i.exist = 1
	</select>

    <!-- 获得是否投入使用的路灯 -->
    <select id="queryByStatus" parameterType="Long" resultMap="BaseResultMap">
		select i.id, i.code, i.`status`, i.current_overload, i.humidity_overload,i.auto_report,
		i.street_id,i.user_id,i.group_id,
		i.current_threshold, i.light_info, i.latitude, i.lightness_overload, i.humidity_threshold,
		i.lightness_threshold, i.longitude, i.strategy_id, i.temperature_overload,
		i.temperature_threshold, i.voltage_overload, i.voltage_threshold,
		ls.open_time, ls.close_time
		from sys_light_info as i
		left join sys_light_strategy as ls on i.strategy_id = ls.id
		where i.status = #{status} and i.exist = 1
	</select>


    <!-- 通过各种条件查询路灯 -->
    <select id="queryWithCondition" resultMap="BaseResultMap">
        select distinct i.id, i.code, i.`status`, i.current_overload, i.humidity_overload,i.auto_report,
        i.street_id,i.user_id,i.group_id,
        i.current_threshold, i.light_info, i.latitude, i.lightness_overload, i.humidity_threshold,
        i.lightness_threshold, i.longitude, i.strategy_id, i.temperature_overload,
        i.temperature_threshold, i.voltage_overload, i.voltage_threshold,
        ls.open_time, ls.close_time
        from sys_light_info as i
        left join sys_light_strategy as ls on i.strategy_id = ls.id
        left join sys_user as us on us.id = i.user_id
        left join sys_region as r on r.common_region_id = i.street_id
        left join sys_region as sr on r.up_region_id = sr.common_region_id
        where 1 = 1 and i.exist = 1
        <if test="areaId != null">and r.up_region_id = #{areaId}</if>
        <if test="areaName != null">and sr.region_name like CONCAT(#{areaName}, '%')</if>
        <if test="cityId != null">and r.common_region_id like CONCAT(#{cityId}, '%') and r.region_desc = '街道'</if>
        <if test="streetId != null">and i.street_id = #{streetId}</if>
        <if test="streetName != null">and r.region_name like CONCAT(#{streetName}, '%')</if>
        <if test="userId != null"> and i.user_id = #{userId}</if>
        <if test="userName != null">and us.nickname = #{userName}</if>
        <if test="groupId != null">and i.group_id = #{groupId}</if>
        <if test="code != null">and i.code like CONCAT('%', #{code}, '%')</if>
        <if test="status != null">and i.status = #{status}</if>
        <if test="longitude != null">and i.longitude = #{longitude}</if>
        <if test="latitude != null">and i.latitude = #{latitude}</if>
        <if test="strategyId != null">and i.strategy_id = #{strategyId}</if>
        <if test="voltageThresholdGt != null"><![CDATA[ and i.voltage_threshold >= #{voltageThresholdGt} ]]></if>
        <if test="voltageThresholdLt != null"><![CDATA[ and i.voltage_threshold <= #{voltageThresholdLt} ]]></if>
        <if test="currentThresholdGt != null"><![CDATA[ and i.current_threshold >= #{currentThresholdGt} ]]></if>
        <if test="currentThresholdLt != null"><![CDATA[ and i.current_threshold <= #{currentThresholdLt} ]]></if>
        <if test="temperatureThresholdGt != null"><![CDATA[ and i.temperature_threshold >= #{temperatureThresholdGt} ]]></if>
        <if test="temperatureThresholdLt != null"><![CDATA[ and i.temperature_threshold @lt;= #{temperatureThresholdLt} ]]></if>
        <if test="humidityThresholdGt != null"><![CDATA[ and i.humidity_threshold @gt;= #{humidityThresholdGt} ]]></if>
        <if test="humidityThresholdLt != null"><![CDATA[ and i.humidity_threshold @lt;= #{humidityThresholdLt} ]]></if>
        <if test="lightnessThresholdGt != null"><![CDATA[ and i.lightness_threshold @gt;= #{lightnessThresholdGt} ]]></if>
        <if test="lightnessThresholdLt != null"><![CDATA[ and i.lightness_threshold @lt;= #{lightnessThresholdLt} ]]></if>
        <if test="voltageOverloadGt != null"><![CDATA[ and i.voltage_overload @gt;= #{voltageOverloadGt} ]]></if>
        <if test="voltageOverloadLt != null"><![CDATA[ and i.voltage_overload @lt;= #{voltageOverloadLt} ]]></if>
        <if test="currentOverloadGt != null"><![CDATA[ and i.current_overload @gt;= #{currentOverloadGt} ]]></if>
        <if test="currentOverloadLt != null"><![CDATA[ and i.current_overload @lt;= #{currentOverloadLt} ]]></if>
        <if test="temperatureOverloadGt != null"><![CDATA[ and i.temperature_overload @gt;= #{temperatureOverloadGt} ]]></if>
        <if test="temperatureOverloadLt != null"><![CDATA[ and i.temperature_overload @lt;= #{temperatureOverloadLt} ]]></if>
        <if test="humidityOverloadGt != null"><![CDATA[ and i.humidity_overload @gt;= #{humidityOverloadGt} ]]></if>
        <if test="humidityOverloadLt != null"><![CDATA[ and i.humidity_overload @lt;= #{humidityOverloadLt} ]]></if>
        <if test="lightnessOverloadGt != null"><![CDATA[ and i.lightness_overload @gt;= #{lightnessOverloadGt} ]]></if>
        <if test="lightnessOverloadLt != null"><![CDATA[ and i.lightness_overload @lt;= #{lightnessOverloadLt} ]]></if>
        <if test="sort == 'asc' ">order by i.id asc</if>
        <if test="sort == 'desc' ">order by i.id desc</if>
    </select>

    <!-- 添加路灯 -->
    <insert id="save" parameterType="com.viroyal.light.module.light.entity.SysLightInfo"
            useGeneratedKeys="true" keyProperty="id">
		insert into sys_light_info
		(
		`id`,
		`code`,
		`light_info`,
		`status`,
		`longitude`,
		`latitude`,
		`strategy_id`,
		`user_id`,
		`street_id`,
		`group_id`,
		`auto_report`,
		`voltage_threshold`,
		`current_threshold`,
		`temperature_threshold`,
		`humidity_threshold`,
		`lightness_threshold`,
		`voltage_overload`,
		`current_overload`,
		`temperature_overload`,
		`humidity_overload`,
		`lightness_overload`
		)
		values
		(
		#{id},
		#{code},
		#{lightInfo},
		#{status},
		#{longitude},
		#{latitude},
		#{strategyId},
		#{userId},
		#{streetId},
		#{groupId},
		#{autoReport},
		#{voltageThreshold},
		#{currentThreshold},
		#{temperatureThreshold},
		#{humidityThreshold},
		#{lightnessThreshold},
		#{voltageOverload},
		#{currentOverload},
		#{temperatureOverload},
		#{humidityOverload},
		#{lightnessOverload}
		)
	</insert>

    <!-- 更新路灯 -->
    <update id="update" parameterType="com.viroyal.light.module.light.entity.SysLightInfo">
        update sys_light_info
        <set>
            <if test="code != null">`code` = #{code},</if>
            <if test="lightInfo != null">`light_info` = #{lightInfo},</if>
            <if test="status != null">`status` = #{status},</if>
            <if test="longitude != null">`longitude` = #{longitude},</if>
            <if test="latitude != null">`latitude` = #{latitude},</if>
            <if test="strategyId != null">`strategy_id` = #{strategyId},</if>
            <if test="userId != null">`user_id` = #{userId},</if>
            <if test="streetId != null">`street_id` = #{streetId},</if>
            <if test="groupId != null">`group_id` = #{groupId},</if>
            <if test="autoReport != null">`auto_report` = #{autoReport},</if>
            <if test="voltageThreshold != null">`voltage_threshold` = #{voltageThreshold},</if>
            <if test="currentThreshold != null">`current_threshold` = #{currentThreshold},</if>
            <if test="temperatureThreshold != null">`temperature_threshold` = #{temperatureThreshold},</if>
            <if test="humidityThreshold != null">`humidity_threshold` = #{humidityThreshold},</if>
            <if test="lightnessThreshold != null">`lightness_threshold` = #{lightnessThreshold},</if>
            <if test="currentOverload != null">`current_overload` = #{currentOverload},</if>
            <if test="temperatureOverload != null">`temperature_overload` = #{temperatureOverload},</if>
            <if test="humidityOverload != null">`humidity_overload` = #{humidityOverload},</if>
            <if test="lightnessOverload != null">`lightness_overload` = #{lightnessOverload}</if>
        </set>
        where id = #{id}
    </update>

    <update id="deleteBatch">
        update sys_light_info set exist = 0 where id in
        <foreach item="lightId" collection="array" open="(" separator="," close=")">
            #{lightId}
        </foreach>
        ;
        update sys_light set exist = 0 where info_id in
        <foreach item="lightId" collection="array" open="(" separator="," close=")">
            #{lightId}
        </foreach>
    </update>

</mapper>
